<div class="welcome-container">
  <h1>Welcome to the Travel Site!</h1>
  <p>Find your next adventure below.</p>
</div>

<div class="content-container">
  <h2>Flight Search</h2>

  <form [formGroup]="flightSearchForm" (ngSubmit)="onSubmit()" novalidate>

    <div>
      <label for="departureId">Departure Airport ID:</label>
      <input id="departureId" type="text" formControlName="departureId">
      <div *ngIf="flightSearchForm.controls['departureId'].invalid && (flightSearchForm.controls['departureId'].dirty || flightSearchForm.controls['departureId'].touched)">
        <small *ngIf="flightSearchForm.controls['departureId'].errors?.['required']">Departure ID is required.</small>
      </div>
    </div>

    <div>
      <label for="arrivalId">Arrival Airport ID:</label>
      <input id="arrivalId" type="text" formControlName="arrivalId">
      <div *ngIf="flightSearchForm.controls['arrivalId'].invalid && (flightSearchForm.controls['arrivalId'].dirty || flightSearchForm.controls['arrivalId'].touched)">
        <small *ngIf="flightSearchForm.controls['arrivalId'].errors?.['required']">Arrival ID is required.</small>
      </div>
    </div>

    <div>
      <label for="outboundDate">Outbound Date:</label>
      <input id="outboundDate" type="date" formControlName="outboundDate">
      <div *ngIf="flightSearchForm.controls['outboundDate'].invalid && (flightSearchForm.controls['outboundDate'].dirty || flightSearchForm.controls['outboundDate'].touched)">
        <small *ngIf="flightSearchForm.controls['outboundDate'].errors?.['required']">Outbound date is required.</small>
      </div>
    </div>

    <div>
      <label for="returnDate">Return Date:</label>
      <input id="returnDate" type="date" formControlName="returnDate">
      <!-- No required validation for return date -->
    </div>

    <div>
      <label>Trip Type:</label>
      <label>
        <input type="radio" formControlName="type" [value]="1"> Round Trip
      </label>
      <label>
        <input type="radio" formControlName="type" [value]="2"> One Way
      </label>
      <div *ngIf="flightSearchForm.controls['type'].invalid && (flightSearchForm.controls['type'].dirty || flightSearchForm.controls['type'].touched)">
        <small *ngIf="flightSearchForm.controls['type'].errors?.['required']">Trip type is required.</small>
      </div>
    </div>

    <div>
      <label for="adults">Adults:</label>
      <input id="adults" type="number" formControlName="adults" min="1">
      <div *ngIf="flightSearchForm.controls['adults'].invalid && (flightSearchForm.controls['adults'].dirty || flightSearchForm.controls['adults'].touched)">
        <small *ngIf="flightSearchForm.controls['adults'].errors?.['required']">Number of adults is required.</small>
        <small *ngIf="flightSearchForm.controls['adults'].errors?.['min']">At least 1 adult is required.</small>
      </div>
    </div>

    <div>
      <label for="children">Children (2-11):</label>
      <input id="children" type="number" formControlName="children" min="0">
       <div *ngIf="flightSearchForm.controls['children'].invalid && (flightSearchForm.controls['children'].dirty || flightSearchForm.controls['children'].touched)">
        <small *ngIf="flightSearchForm.controls['children'].errors?.['min']">Number of children cannot be negative.</small>
      </div>
    </div>

    <div>
      <label for="infantsInSeat">Infants (in seat):</label>
      <input id="infantsInSeat" type="number" formControlName="infantsInSeat" min="0">
      <div *ngIf="flightSearchForm.controls['infantsInSeat'].invalid && (flightSearchForm.controls['infantsInSeat'].dirty || flightSearchForm.controls['infantsInSeat'].touched)">
          <small *ngIf="flightSearchForm.controls['infantsInSeat'].errors?.['min']">Number of infants in seat cannot be negative.</small>
      </div>
    </div>

    <div>
      <label for="infantsOnLap">Infants (on lap):</label>
      <input id="infantsOnLap" type="number" formControlName="infantsOnLap" min="0">
      <div *ngIf="flightSearchForm.controls['infantsOnLap'].invalid && (flightSearchForm.controls['infantsOnLap'].dirty || flightSearchForm.controls['infantsOnLap'].touched)">
        <small *ngIf="flightSearchForm.controls['infantsOnLap'].errors?.['min']">Number of infants on lap cannot be negative.</small>
      </div>
    </div>

    <button type="submit" [disabled]="!flightSearchForm.valid || isLoading">
      {{ isLoading ? 'Searching...' : 'Search Flights' }}
    </button>

  </form>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="loading-indicator">
    Searching for flights...
  </div>

  <!-- Error Display -->
  <div *ngIf="searchError" class="error-message">
    <h4>Search Error</h4>
    <p>{{ searchError }}</p>
  </div>

  <!-- Results Display -->
  <div *ngIf="flightResults && !isLoading" class="results-container">
    <h3>Search Results</h3>

    <!-- Only show departure selection section if it's a round trip and departure hasn't been selected -->
    <div *ngIf="flightSearchForm.value.type === 1 && !selectedDepartureFlightToken">
      <h4>Select Your Departing Flight</h4>

      <div *ngIf="flightResults.error_message">
        <p class="error-message">Error from API: {{ flightResults.error_message }}</p>
      </div>

      <!-- Check if flightResults and necessary arrays exist before accessing length -->
      <div *ngIf="!(flightResults.best_flights?.length || flightResults.other_flights?.length) && !flightResults.error_message">
        <p>No departing flights found for your criteria.</p>
      </div>

      <!-- Display Best Departing Flights -->
      <div *ngIf="flightResults.best_flights?.length">
        <h5>Best Departing Flights</h5>
        <ul class="flight-list">
          <li *ngFor="let flight of flightResults.best_flights" class="flight-option">
            <div class="flight-summary">
              <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights[0].airline }} logo" class="airline-logo">
              <span *ngIf="!flight.airline_logo">{{ flight.flights[0].airline }}</span>
              <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
            </div>
            <ul class="segment-list">
              <ng-container *ngFor="let segment of flight.flights; let i = index">
                <li class="flight-segment">
                  <div class="segment-details">
                    <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                    <div>
                      {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                      <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                      <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                      <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                    </div>
                    <div *ngIf="segment.extensions?.length" class="segment-extensions">
                      <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                    </div>
                  </div>
                </li>
                <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                  Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                </li>
              </ng-container>
            </ul>
            <div *ngIf="flight.extensions?.length" class="flight-extensions">
               <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
            </div>
            <div *ngIf="flight.carbon_emissions" class="carbon-emissions">
               <small *ngIf="flight.carbon_emissions.this_flight !== undefined">Carbon Emissions: {{ flight.carbon_emissions.this_flight / 1000 }} kg
                 <span *ngIf="flight.carbon_emissions.difference_percent !== undefined">({{ flight.carbon_emissions.difference_percent > 0 ? '+' : '' }}{{flight.carbon_emissions.difference_percent }}% vs typical)</span>
              </small>
            </div>
            <!-- Add Select Departure Button -->
            <button *ngIf="flight.departure_token" (click)="selectDepartureFlight(flight.departure_token)" [disabled]="isProcessingSelection">
              Select Departure
            </button>
          </li>
        </ul>
      </div>

      <!-- Display Other Departing Flights -->
      <div *ngIf="flightResults.other_flights?.length">
        <h5>Other Departing Flights</h5>
        <ul class="flight-list">
          <li *ngFor="let flight of flightResults.other_flights" class="flight-option">
            <div class="flight-summary">
              <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights[0].airline }} logo" class="airline-logo">
               <span *ngIf="!flight.airline_logo">{{ flight.flights[0].airline }}</span>
              <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
            </div>
            <ul class="segment-list">
              <ng-container *ngFor="let segment of flight.flights; let i = index">
                <li class="flight-segment">
                   <div class="segment-details">
                    <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                    <div>
                      {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                      <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                      <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                      <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                    </div>
                     <div *ngIf="segment.extensions?.length" class="segment-extensions">
                       <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                     </div>
                  </div>
                </li>
                <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                    Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                </li>
              </ng-container>
            </ul>
             <div *ngIf="flight.extensions?.length" class="flight-extensions">
               <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
            </div>
            <!-- Add Select Departure Button -->
            <button *ngIf="flight.departure_token" (click)="selectDepartureFlight(flight.departure_token)" [disabled]="isProcessingSelection">
              Select Departure
            </button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Show message if departure selected OR if it was a one-way trip -->
    <div *ngIf="selectedDepartureFlightToken">

      <!-- For one-way trips, show initial results -->
      <div *ngIf="flightSearchForm.value.type === 2">
          <h4>One-way flight results:</h4>
          <!-- Display Best Flights (Initial Results) -->
          <div *ngIf="flightResults?.best_flights?.length">
             <h5>Best Flights</h5>
            <ul class="flight-list">
              <li *ngFor="let flight of flightResults.best_flights" class="flight-option">
                <div class="flight-summary">
                  <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights[0].airline }} logo" class="airline-logo">
                  <span *ngIf="!flight.airline_logo">{{ flight.flights[0].airline }}</span>
                  <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
                </div>
                <ul class="segment-list">
                   <ng-container *ngFor="let segment of flight.flights; let i = index">
                     <li class="flight-segment">
                       <div class="segment-details">
                         <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                         <div>
                           {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                           <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                           <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                           <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                           <span *ngIf="segment.overnight" class="overnight-warning"> (Overnight)</span>
                           <div *ngIf="segment.plane_and_crew_by" class="crew-info"><small>Operated by {{ segment.plane_and_crew_by }}</small></div>
                         </div>
                         <div *ngIf="segment.extensions?.length" class="segment-extensions">
                           <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                         </div>
                         <div *ngIf="segment.ticket_also_sold_by?.length" class="sold-by-info">
                            <small>Also sold by: {{ segment.ticket_also_sold_by?.join(', ') }}</small>
                         </div>
                       </div>
                     </li>
                     <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                        Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                     </li>
                   </ng-container>
                 </ul>
                 <div *ngIf="flight.extensions?.length" class="flight-extensions">
                    <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
                 </div>
                 <div *ngIf="flight.carbon_emissions" class="carbon-emissions">
                    <small *ngIf="flight.carbon_emissions.this_flight !== undefined">Carbon Emissions: {{ flight.carbon_emissions.this_flight / 1000 }} kg
                      <span *ngIf="flight.carbon_emissions.difference_percent !== undefined">({{ flight.carbon_emissions.difference_percent > 0 ? '+' : '' }}{{flight.carbon_emissions.difference_percent }}% vs typical)</span>
                   </small>
                 </div>
              </li>
            </ul>
          </div>
          <!-- Display Other Flights (Initial Results) -->
          <div *ngIf="flightResults?.other_flights?.length">
             <h5>Other Flights</h5>
            <ul class="flight-list">
              <li *ngFor="let flight of flightResults.other_flights" class="flight-option">
                <div class="flight-summary">
                   <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights[0].airline }} logo" class="airline-logo">
                    <span *ngIf="!flight.airline_logo">{{ flight.flights[0].airline }}</span>
                   <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
                 </div>
                 <ul class="segment-list">
                   <ng-container *ngFor="let segment of flight.flights; let i = index">
                     <li class="flight-segment">
                        <div class="segment-details">
                         <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                         <div>
                           {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                           <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                           <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                           <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                           <span *ngIf="segment.overnight" class="overnight-warning"> (Overnight)</span>
                           <div *ngIf="segment.plane_and_crew_by" class="crew-info"><small>Operated by {{ segment.plane_and_crew_by }}</small></div>
                         </div>
                          <div *ngIf="segment.extensions?.length" class="segment-extensions">
                            <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                          </div>
                           <div *ngIf="segment.ticket_also_sold_by?.length" class="sold-by-info">
                              <small>Also sold by: {{ segment.ticket_also_sold_by?.join(', ') }}</small>
                           </div>
                        </div>
                       </li>
                       <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                           Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                       </li>
                   </ng-container>
                 </ul>
                  <div *ngIf="flight.extensions?.length" class="flight-extensions">
                    <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
                 </div>
             </li>
           </ul>
         </div>
      </div>

      <!-- For Round Trips, after departure selection -->
      <div *ngIf="flightSearchForm.value.type === 1">
        <h4>Your Selected Trip</h4>

        <!-- Loading Indicator for Selection Process -->
        <div *ngIf="isProcessingSelection" class="loading-indicator">
          Retrieving flight details and booking options...
        </div>

        <!-- Error Display for Selection Process -->
        <div *ngIf="selectionError && !isProcessingSelection" class="error-message">
          <h4>Error Retrieving Details</h4>
          <p>{{ selectionError }}</p>
        </div>

        <!-- Display Final Selected Flight Pair and Booking Options -->
        <div *ngIf="finalFlightPairResponse && !isProcessingSelection && !selectionError">

          <!-- TODO: Display the *already selected* outbound flight details here for context -->
          <!-- You might need to store the selected outbound flight object separately -->
          <!-- For now, just showing return flight options -->

          <h4>Select Return Flight</h4>

          <!-- Display Best Return Flights -->
          <div *ngIf="finalFlightPairResponse.best_flights?.length">
             <h5>Best Return Flights</h5>
            <ul class="flight-list">
              <!-- Loop through best_flights for return options -->
              <li *ngFor="let flight of finalFlightPairResponse.best_flights" class="flight-option">
                <!-- Reuse flight display structure -->
                <div class="flight-summary">
                  <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights && flight.flights[0].airline }} logo" class="airline-logo small">
                  <span *ngIf="!flight.airline_logo && flight.flights">{{ flight.flights[0].airline }}</span>
                   <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
                </div>
                <ul class="segment-list">
                   <ng-container *ngFor="let segment of flight.flights; let i = index">
                     <li class="flight-segment">
                       <div class="segment-details">
                         <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                         <div>
                           {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                           <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                           <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                           <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                           <span *ngIf="segment.overnight" class="overnight-warning"> (Overnight)</span>
                           <div *ngIf="segment.plane_and_crew_by" class="crew-info"><small>Operated by {{ segment.plane_and_crew_by }}</small></div>
                         </div>
                          <div *ngIf="segment.extensions?.length" class="segment-extensions">
                            <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                          </div>
                           <div *ngIf="segment.ticket_also_sold_by?.length" class="sold-by-info">
                              <small>Also sold by: {{ segment.ticket_also_sold_by?.join(', ') }}</small>
                           </div>
                        </div>
                       </li>
                       <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                           Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                       </li>
                   </ng-container>
                 </ul>
                  <div *ngIf="flight.extensions?.length" class="flight-extensions">
                    <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
                 </div>
                 <div *ngIf="flight.carbon_emissions" class="carbon-emissions">
                    <small *ngIf="flight.carbon_emissions.this_flight !== undefined">Carbon Emissions: {{ flight.carbon_emissions.this_flight / 1000 }} kg
                      <span *ngIf="flight.carbon_emissions.difference_percent !== undefined">({{ flight.carbon_emissions.difference_percent > 0 ? '+' : '' }}{{flight.carbon_emissions.difference_percent }}% vs typical)</span>
                    </small>
                  </div>
                <!-- Add Select Return Button -->
                <button *ngIf="flight.booking_token" (click)="initiateBooking(flight.booking_token)" [disabled]="isProcessingSelection">
                  Select Return Flight
                </button>
              </li>
            </ul>
          </div>

          <!-- Display Other Return Flights -->
          <div *ngIf="finalFlightPairResponse.other_flights?.length">
             <h5>Other Return Flights</h5>
            <ul class="flight-list">
              <!-- Loop through other_flights for return options -->
              <li *ngFor="let flight of finalFlightPairResponse.other_flights" class="flight-option">
                 <!-- Reuse flight display structure -->
                 <div class="flight-summary">
                   <img *ngIf="flight.airline_logo" [src]="flight.airline_logo" alt="{{ flight.flights && flight.flights[0].airline }} logo" class="airline-logo small">
                   <span *ngIf="!flight.airline_logo && flight.flights">{{ flight.flights[0].airline }}</span>
                   <span>{{ flight.price | currency }} ({{ flight.type }}) - Total Duration: {{ flight.total_duration }} min</span>
                 </div>
                 <ul class="segment-list">
                   <ng-container *ngFor="let segment of flight.flights; let i = index">
                     <li class="flight-segment">
                        <div class="segment-details">
                         <strong>{{ segment.airline }} {{ segment.flight_number }}</strong> <span *ngIf="segment.airplane">({{ segment.airplane }})</span>
                         <div>
                           {{ segment.departure_airport?.id }} ({{ segment.departure_airport?.time | date:'shortTime' }}) -> {{ segment.arrival_airport?.id }} ({{ segment.arrival_airport?.time | date:'shortTime' }})
                           <br>Duration: {{ segment.duration }} min | {{ segment.travel_class }}
                           <span *ngIf="segment.legroom"> | Legroom: {{ segment.legroom }}</span>
                           <span *ngIf="segment.often_delayed_by_over_30_min" class="delay-warning"> (Often delayed > 30 min)</span>
                           <span *ngIf="segment.overnight" class="overnight-warning"> (Overnight)</span>
                           <div *ngIf="segment.plane_and_crew_by" class="crew-info"><small>Operated by {{ segment.plane_and_crew_by }}</small></div>
                         </div>
                          <div *ngIf="segment.extensions?.length" class="segment-extensions">
                            <small *ngFor="let ext of segment.extensions">{{ ext }}</small>
                          </div>
                           <div *ngIf="segment.ticket_also_sold_by?.length" class="sold-by-info">
                              <small>Also sold by: {{ segment.ticket_also_sold_by?.join(', ') }}</small>
                           </div>
                        </div>
                       </li>
                       <li *ngIf="flight.layovers && flight.layovers[i]" class="layover-info">
                           Layover at {{ flight.layovers[i].name }} ({{ flight.layovers[i].id }}) for {{ flight.layovers[i].duration }} min
                       </li>
                   </ng-container>
                 </ul>
                  <div *ngIf="flight.extensions?.length" class="flight-extensions">
                    <strong>Notes:</strong> <small *ngFor="let ext of flight.extensions; let isLast = last">{{ ext }}{{ !isLast ? ', ' : '' }}</small>
                 </div>
                 <div *ngIf="flight.carbon_emissions" class="carbon-emissions">
                   <small *ngIf="flight.carbon_emissions.this_flight !== undefined">Carbon Emissions: {{ flight.carbon_emissions.this_flight / 1000 }} kg
                     <span *ngIf="flight.carbon_emissions.difference_percent !== undefined">({{ flight.carbon_emissions.difference_percent > 0 ? '+' : '' }}{{flight.carbon_emissions.difference_percent }}% vs typical)</span>
                   </small>
                 </div>
                <!-- Add Select Return Button -->
                <button *ngIf="flight.booking_token" (click)="initiateBooking(flight.booking_token)" [disabled]="isProcessingSelection">
                  Select Return Flight
                </button>
              </li>
            </ul>
          </div>

          <!-- Keep Baggage Info if needed -->
          <div *ngIf="finalFlightPairResponse.baggage_prices?.together?.length" class="baggage-info-section">
              <h5>Baggage Information</h5>
              <ul>
                  <li *ngFor="let item of finalFlightPairResponse.baggage_prices?.together">{{ item }}</li>
              </ul>
          </div>

          <!-- Display Booking Options -->
          <div *ngIf="finalFlightPairResponse.booking_options?.length" class="booking-options-section">
            <h5>Booking Options</h5>
            <ul class="booking-list">
              <li *ngFor="let option of finalFlightPairResponse.booking_options" class="booking-option">
                  <div *ngIf="option.together" class="booking-details">
                      <div class="booking-header">
                          <img *ngIf="option.together.airline_logos?.length" [src]="option.together.airline_logos?.[0]" alt="{{ option.together.book_with }} logo" class="airline-logo small">
                          <strong>{{ option.together.option_title }}</strong> with <strong>{{ option.together.book_with }}</strong>
                          <span class="price">{{ option.together.price | currency }}</span>
                           <span *ngIf="option.together.local_prices?.length"> ({{ option.together.local_prices?.[0]?.price | currency:option.together.local_prices?.[0]?.currency }})</span>
                      </div>
                      <div *ngIf="option.together.marketed_as?.length" class="marketed-as">
                          <small>Marketed as: {{ option.together.marketed_as?.join(', ') }}</small>
                      </div>
                      <div *ngIf="option.together.extensions?.length" class="booking-extensions">
                          <ul>
                              <li *ngFor="let ext of option.together.extensions">{{ ext }}</li>
                          </ul>
                      </div>
                       <div *ngIf="option.together.baggage_prices?.length" class="booking-baggage">
                          <strong>Baggage:</strong>
                          <ul>
                              <li *ngFor="let bagExt of option.together.baggage_prices">{{ bagExt }}</li>
                          </ul>
                      </div>
                      <button (click)="initiateBooking(option.together.booking_request?.post_data)" [disabled]="!option.together.booking_request?.post_data">
                          Book with {{ option.together.book_with }}
                      </button>
                  </div>
              </li>
            </ul>
          </div>

        </div> <!-- End of finalFlightPairResponse block -->
      </div> <!-- End of round trip block -->
    </div> <!-- End of selectedDepartureFlightToken block -->

  </div> <!-- End of initial results container -->

</div>
